---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.13.0
      jupytext_formats: ipynb,Rmd:rmarkdown
  kernelspec:
    display_name: bioinf
    language: python
    name: bioinf
---

```{python}
# %autosave 0
```

## Load cifar data, fetch pretrained convnet

```{python}
from info_nas.datasets.networks.pretrained import pretrain_network_cifar
from info_nas.datasets.networks.utils import load_nasbench
from nasbench_pytorch.datasets.cifar10 import prepare_dataset
```

```{python}
seed = 42
batch_size = 32
num_workers = 2

dataset = prepare_dataset(batch_size, root='../data/cifar/', validation_size=1000, random_state=seed,
                          num_workers=num_workers)
train, n_train, val, n_val, test, n_test = dataset
```

```{python}
import os

checkpoint_dir = '../data/train_checkpoints/'

os.listdir(f'{checkpoint_dir}')
```

```{python}
from nasbench import api

nasbench_path = '../data/nasbench_only108.tfrecord'
nb = api.NASBench(nasbench_path)
```

```{python}
import torch
from info_nas.datasets.networks.utils import load_trained_net

device = torch.device('cuda') if torch.cuda.is_available() else torch.device('cpu')

net_path = f'{checkpoint_dir}083a8045a46ac2a25a34c8fab47f6ecb.tar'
net_hash, net, info = load_trained_net(net_path, nb, device=device)
net
```

```{python}
info
```

## Visualize learned weights

```{python}
import matplotlib.pyplot as plt
import seaborn as sns
# %matplotlib notebook

labels = "airplane, automobile, bird, cat, deer, dog, frog, horse, ship, truck".split(', ')

weights = net.classifier.weight.detach().cpu()

plt.figure(figsize=(5,6))
sns.heatmap(weights, yticklabels=labels)
#plt.imshow(net.classifier.weight.detach().cpu())
plt.tight_layout()
plt.savefig('cifar_weights.png')
plt.show()
```

```{python}
for batch_idx, (inputs, targets) in enumerate(val):
    inputs, targets = inputs.to(device), targets.to(device)
    break
    
print(inputs.shape)
print(targets.shape)
```

```{python}

```
