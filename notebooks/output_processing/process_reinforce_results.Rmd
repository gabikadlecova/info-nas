---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.13.0
  kernelspec:
    display_name: pyt_conda
    language: python
    name: pyt_conda
---

```{python}
import torch

#torch.cuda.random.get_rng_state()
#torch.random.get_rng_state()
```

```{python}
# %autosave 0
import os

data_dir = '/home/gabi/diplomka/code/info-nas/data/paper_final_results'
os.listdir(data_dir)
```

```{python}
def process_one_run(file):
    with open(file, 'rb') as f:
        res = json.load(f)
        
    res_df = pd.DataFrame(res)
    res_df['name'] = os.path.basename(file).replace('.json', '')
    basef = os.path.basename(file)
    basef = basef.replace('run_', '')
    
    num = ''
    for i in basef:
        try:
            int(i)
        except:
            break
        num += i
    res_df['seed'] = int(num)
    
    return res_df
```

```{python}
seed = 3

runs = {
    'Accuracy 2': ('accuracy', 'orig'),
    'Accuracy 1': ('accuracy', 'dense'),
    'IO Model 2': ('info-nas', 'orig'),
    'IO Model 1': ('info-nas', 'dense'),
    'arch2vec': ('info-nas', 'ref'),
    'arch2vec original': ('arch2vec_orig', 'original')
}
```

```{python}
import glob
import json
import pandas as pd

train_time_sum = 138070.05435689294

def get_runs(name, pathnames, nb_time=None):
    seed_it = seed if name != 'arch2vec original' else 1
    runs_dir = os.path.join(data_dir, f"{pathnames[0]}_seeds", f"seed_{seed_it}", "reinforce-runs")
    runs_paths = glob.glob(os.path.join(runs_dir, f'run_*{pathnames[1]}*.json'))
    print(runs_dir)
    run_dfs = [process_one_run(f) for f in runs_paths]
    
    run_dfs = pd.concat(run_dfs, axis=0, ignore_index=True)
    run_dfs['algo'] = name
    run_dfs['runtime_shifted'] = run_dfs['runtime']
    if nb_time is not None:
        run_dfs['runtime_shifted'] += nb_time
    return run_dfs
    
res_dfs = []
for n, p in runs.items():
    res_dfs.append(get_runs(n, p, nb_time=train_time_sum if 'arch2vec' not in n else None))
```

```{python}
plot_dfs = pd.concat(res_dfs, axis=0, ignore_index=True)
plot_dfs
```

```{python}
plot_dfs = plot_dfs.sort_values('algo')
```

```{python}
import matplotlib.pyplot as plt
import seaborn as sns
sns.set(font_scale=1.2)

save_dir = '/home/gabi/Dropbox/automl-conf/LatexTemplate/img'

plot_dfs['rounded_runtime'] = plot_dfs['runtime'].round(decimals=-4)
plot_dfs['rounded_runtime_shifted'] = plot_dfs['runtime_shifted'].round(decimals=-4)

plt.figure(figsize=(8,6))
sns.lineplot(data=plot_dfs, x='rounded_runtime', y='regret_test', hue='algo')
plt.xscale('log')
plt.yscale('log')
plt.title('REINFORCE run without shifted time')
plt.xlabel('Estimated runtime in seconds')
plt.ylabel('Test regret')
plt.savefig(f"{save_dir}/reinf.png")
plt.show()

plt.figure(figsize=(8,6))
sns.lineplot(data=plot_dfs, x='rounded_runtime_shifted', y='regret_test', hue='algo')
plt.xscale('log')
plt.yscale('log')
plt.title('REINFORCE run with time shifted by network training time')
plt.xlabel('Estimated runtime in seconds')
plt.ylabel('Test regret')
plt.savefig(f"{save_dir}/reinf_shifted.png")
plt.show()
```

```{python}
plot_dfs[['algo', 'regret_test']].groupby('algo').min()
```

```{python}

```

```{python}
import matplotlib as mpl
from matplotlib.lines import Line2D


def fix_hist_step_vertical_line_at_end(ax):
    axpolygons = [poly for poly in ax.get_children() if isinstance(poly, mpl.patches.Polygon)]
    for poly in axpolygons:
        poly.set_xy(poly.get_xy()[:-1])

fig = plt.figure(figsize=(10,7))
ax = fig.add_subplot(1, 1, 1)
    
cmap = plt.get_cmap("tab10")

for i, a in enumerate(plot_dfs['algo'].unique()):
    pdfs = plot_dfs[(plot_dfs['algo'] == a) & \
                    (plot_dfs['rounded_runtime_shifted'] == 1e6)]['regret_test'].to_list()
    print(len(pdfs))

    plt.hist(pdfs, bins=10, range=[8e-4, 1.2e-2], density=True,
             cumulative=True, histtype='step', linestyle='--', color=cmap(i), lw=2,
             label=a)

fix_hist_step_vertical_line_at_end(ax)


ax.set_xscale('log')
ax.set_xlabel('final test regret', fontsize=12)
ax.set_ylabel('CDF', fontsize=12)
handles, labels = ax.get_legend_handles_labels()
new_handles = [Line2D([], [], c=h.get_edgecolor()) for h in handles]
ax.legend(prop={"size":8}, handles=new_handles, labels=labels, loc='upper left')


plt.show()
```

```{python}

```
